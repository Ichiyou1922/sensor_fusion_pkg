# sensor_fusion_pkg

## 理論
1. 状態方程式
```math
x_{k}=Fx_{k-1}+Bu_{k}+w_{k}
```
- 状態ベクトル: $x_{k}\in \mathbb{R^{n}}$
    - 推定したい量を全て並べたもの．
- 状態遷移行列: $F\in \mathbb{R^{n\times n}}$
    - 1ステップ前の状態が，今の状態にどう線形変換されるかを記述する行列．
- 制御入力 $u_{k}$ と制御行列 $\mathbf{B}$
    - 何かしらの司令
    - 今回制御入力を使わないため，どちらも0．
- プロセス雑音 $w_{k}$
    - 平均0のガウス雑音と仮定する．
```math
w_{k}\sim \mathcal{N}(0,\mathcal{Q})
```
2. 観測方程式
```math
z_{k}=Hx_{k}+v_{k}
```
- 観測ベクトル: $z_{k}\in \mathbb{R^{m}}$
    - センサが返す値．
    - 状態の次元とは異なる可能性もある．例えば状態は3次元でも，センサがそのうち1つの次元についてしかわからない場合など．
- 観測行列: $H\in \mathbb{R^{m\times n}}$
    - 状態ベクトルから観測値を取り出す．
- 観測雑音: $v_{k}$
    - センサのノイズ->ガウス雑音
```math
v_{k}\sim \mathcal{N}(0, \mathcal{R})
```
3. 予測
- 目的は時刻kにおける状態分布 $p(x_{k}|z_{1:k})$ を計算すること．
3.1. 予測ステップ
- 1ステップ前の事後分布 $x_{k-1}|z_{1:k-1}\sim \mathcal{N}(\mu_{k-1},\mathcal{P_{k-1}})$ が既知として，コレを状態方程式に通せば，時刻kの事前分布が得られる．
```math
x_{k}=Fx_{k-1}+Bu_{k}+w_{k}
```
- ガウス分布に線形変換をかけてもガウス分布のままだから，
```math
x_{k}|z_{1:k-1}\sim \mathcal{\mu_{k}^{-},\mathcal{P}_{k}^{-}}
```
- 平均(予測値)は
```math
\mu_{k}^{-}=F\mu_{k-1}+Bu_{k}
```
- 共分散(予測の不確かさ)は
```math
\mathcal{P}_{k}^{-}=F\mathcal{P}_{k-1}F^{T}+\mathcal{Q}
```
- 右辺第1項目
```math
F\mathcal{P}_{k-1}F^{T}
``` 
では以前の推定の不確かさがモデルに従って広がる．
- $\mathcal{Q}$ が大きければフィルタはモデルを信用しない．逆なら信用する．
- 今回 $u_{k}, B = 0$ だから，予測ステップは
```math
\mu_{k}^{-}=F\mu_{k-1}
```
```math
\mathcal{P}_{k}^{-}=F\mathcal{P}_{k-1}F^{T}+\mathcal{Q}
```
4. 更新
- 観測予測
```math
\hat z_{k}=\mathcal{H}\mu_{k}^{-}
```
    - 観測値が来る前にフィルタが予測するもの．
- イノベーション
```math
y_{k}=z_{k}-\hat z_{k}
```
    - 予測と現実のズレ
- イノベーション共分散
```math
\mathcal{S}_{k}=\mathcal{H}\mathcal{P}_{k}^{-}\mathcal{H}^{T}+\mathcal{R}
```
    - この値が大きいほど観測の信頼度が低い．
- カルマンゲイン
```math
\mathcal{K}_{k}=\mathcal{P}_{k}^{-}\mathcal{H}^{T}\mathcal{S}_{k}^{-1}
```
    - 予測の不確かさ $P_{k}^{-1}$ が大きい-> $K_{k}$ が大きくなる．
    - 観測の不確かさ $R$ が大きい-> $S_{k}$ が大きい-> $K_{k}$ が小さくなる．
- 最終的な事後平均
```math
\mu_{k}=\mu_{k}^{-}+\mathcal{K}_{k}y_{k}
```
    - 予測に「ズレ×どれだけ観測を信じるか」を足す．
- 最終的な事後共分散
```math
\mathcal{P}_{k}=(\mathcal{I}-\mathcal{K}_{k}\mathcal{H}\mathcal{P}_{k}^{-})
```
    - 更新後の不確かさを表す．

- 予測ステップ: 時間発展によって事前分布を計算する．
- 更新ステップ: 観測に基づいて事後分布を計算する．
- この2つの操作を繰り返す．
